# ADR-001: Pure C++ Implementation for LiteCNN Inference

**Status:** Accepted  
**Date:** 2026-02-05  
**Deciders:** Development Team  

## Context

ìš°ë¦¬ëŠ” LiteCNNPro ëª¨ë¸(600K íŒŒë¼ë¯¸í„°, 120 í´ë˜ìŠ¤)ì„ ìœ„í•œ ê²½ëŸ‰ ì¶”ë¡  API ì„œë²„ê°€ í•„ìš”í–ˆìŠµë‹ˆë‹¤. ì£¼ìš” ì œì•½ ì¡°ê±´ì€:

- **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ < 50MB**
- **ë°ë“œë¼ì¸: 19:00 (2026-02-05)**
- **ì…ë ¥:** 224x224 RGB ì´ë¯¸ì§€
- **ì¶œë ¥:** Top-5 ì˜ˆì¸¡ + í•œêµ­ì–´ í’ˆì¢…ëª…

## Decision Drivers

1. **ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±**: ê¸°ì¡´ PyTorch ê¸°ë°˜ ì„œë²„(322MB)ëŠ” ëª©í‘œ ì´ˆê³¼
2. **ì˜ì¡´ì„± ìµœì†Œí™”**: ë°°í¬ ë° ìœ ì§€ë³´ìˆ˜ ìš©ì´ì„±
3. **ì¶”ë¡  ì†ë„**: ì‹¤ì‹œê°„ ì‘ë‹µ ìš”êµ¬ì‚¬í•­
4. **ë‹¤êµ­ì–´ ì§€ì›**: í•œêµ­ì–´ í’ˆì¢…ëª… í•„ìˆ˜

## Considered Options

### Option 1: FastAPI + PyTorch (Baseline)
- **ë©”ëª¨ë¦¬:** 322MB âŒ
- **ì¥ì :** ë¹ ë¥¸ ê°œë°œ, PyTorch ìƒíƒœê³„ í™œìš©
- **ë‹¨ì :** ë©”ëª¨ë¦¬ ëª©í‘œ ì´ˆê³¼ (644%)

### Option 2: LibTorch C++
- **ë©”ëª¨ë¦¬:** 130MB âŒ
- **ì¥ì :** PyTorch í˜¸í™˜ì„±, C++ ì„±ëŠ¥
- **ë‹¨ì :** ëŸ°íƒ€ì„ í¬ê¸° (50-70MB), ì—¬ì „íˆ ëª©í‘œ ì´ˆê³¼ (260%)

### Option 3: ONNX Runtime C++
- **ë©”ëª¨ë¦¬:** 102MB âŒ
- **ì¥ì :** ê²½ëŸ‰í™”ëœ ëŸ°íƒ€ì„, í¬ë¡œìŠ¤ í”Œë«í¼
- **ë‹¨ì :** ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨ ì´ìŠˆ, ë””ë²„ê¹… ì–´ë ¤ì›€

### Option 4: Pure C++ Implementation âœ…
- **ë©”ëª¨ë¦¬:** 26MB âœ…
- **ì¥ì :**
  - ëª©í‘œ ëŒ€ë¹„ 48% ì ˆì•½
  - ì œë¡œ ì˜ì¡´ì„± (í—¤ë” ì˜¨ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë§Œ ì‚¬ìš©)
  - ì™„ì „í•œ ì œì–´ ê°€ëŠ¥
  - ìµœê³  ì„±ëŠ¥
- **ë‹¨ì :**
  - ë†’ì€ ì´ˆê¸° ê°œë°œ ë¹„ìš© (~716 ì¤„ ì½”ë“œ)
  - ìˆ˜ë™ ë ˆì´ì–´ êµ¬í˜„ í•„ìš”

## Decision

**Pure C++ Implementation (Option 4)** ì„ íƒ

## Rationale

1. **ë©”ëª¨ë¦¬ íš¨ìœ¨ì„± ë‹¬ì„±**
   - 26MB ì‹¤ì œ ì‚¬ìš© (RSS)
   - ëª©í‘œ 50MBì˜ 52%ë§Œ ì‚¬ìš©
   - PyTorch ëŒ€ë¹„ 92% ê°ì†Œ

2. **ì˜ì¡´ì„± ìµœì†Œí™” ì„±ê³µ**
   ```
   - cpp-httplib (í—¤ë” ì˜¨ë¦¬)
   - stb_image (í—¤ë” ì˜¨ë¦¬)
   - nlohmann/json (í—¤ë” ì˜¨ë¦¬)
   ```
   - ëŸ°íƒ€ì„ ì˜ì¡´ì„± ì—†ìŒ
   - ë‹¨ì¼ ë°”ì´ë„ˆë¦¬ ë°°í¬

3. **ì™„ì „í•œ ì»¤ìŠ¤í„°ë§ˆì´ì§•**
   - í•œêµ­ì–´ í’ˆì¢…ëª… ë„¤ì´í‹°ë¸Œ ì§€ì›
   - ì‘ë‹µ í¬ë§· ììœ ë¡œìš´ ì„¤ê³„
   - ìµœì í™” ì™„ì „ ì œì–´

4. **í”„ë¡œë•ì…˜ ì¤€ë¹„ ì™„ë£Œ**
   - HTTP API (health check + predict)
   - ì—ëŸ¬ í•¸ë“¤ë§
   - ìë™ ì´ë¯¸ì§€ ì „ì²˜ë¦¬
   - í¬ë¡œìŠ¤ í”Œë«í¼ (macOS, Linux, Windows)

## Implementation Details

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          HTTP Server (cpp-httplib)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Image Preprocessing (STB)              â”‚
â”‚  - Decode (JPEG/PNG)                    â”‚
â”‚  - Resize (224x224)                     â”‚
â”‚  - Normalize (ImageNet mean/std)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  LiteCNNPro Model (Pure C++)            â”‚
â”‚  - Stem (Conv2D + BN + ReLU6)           â”‚
â”‚  - 7x DepthwiseSeparableConv blocks     â”‚
â”‚  - SE (Squeeze-Excitation) blocks       â”‚
â”‚  - Classifier (FC â†’ 512â†’256â†’120)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Response Builder (nlohmann/json)       â”‚
â”‚  - Top-5 predictions                    â”‚
â”‚  - Softmax probabilities                â”‚
â”‚  - Korean breed names                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Layers Implemented (716 lines)

1. **Tensor Operations**
   - Shape manipulation
   - Memory layout (NCHW)
   - Data access patterns

2. **CNN Layers**
   - Conv2D (standard & depthwise)
   - BatchNorm2D (inference mode)
   - AdaptiveAvgPool2D
   - Linear (fully connected)

3. **Activation Functions**
   - ReLU6 (in-place)
   - Sigmoid

4. **Special Blocks**
   - SE Block (channel attention)
   - Depthwise Separable Convolution

### Weight Format

Binary format (Big Endian):
```
[Magic: "LCNN"] [Version: uint32] [Num Tensors: uint32]
For each tensor:
  [Name Length: uint32] [Name: char[]] [Rank: uint32]
  [Shape: uint32[rank]] [Data: float[product(shape)]]
```

### API Endpoints

**GET /health**
```json
{"status": "ok"}
```

**POST /predict**
```bash
curl -X POST http://localhost:8080/predict \
  -F "image=@dog.jpg"
```

Response:
```json
{
  "predictions": [
    {
      "class_id": 81,
      "score": 0.95,
      "breed_en": "Border collie",
      "breed_ko": "ë³´ë” ì½œë¦¬"
    }
  ]
}
```

## Consequences

### Positive

âœ… **ë©”ëª¨ë¦¬ ëª©í‘œ ë‹¬ì„±** (26MB < 50MB)  
âœ… **PyTorch ëŒ€ë¹„ 92% ë©”ëª¨ë¦¬ ì ˆê°**  
âœ… **ì œë¡œ ëŸ°íƒ€ì„ ì˜ì¡´ì„±**  
âœ… **í•œêµ­ì–´ í’ˆì¢…ëª… ì§€ì›**  
âœ… **ë¹ ë¥¸ ì¶”ë¡  ì†ë„** (ì „ì²˜ë¦¬ + ì¶”ë¡  < 100ms)  
âœ… **í¬ë¡œìŠ¤ í”Œë«í¼ í˜¸í™˜**  
âœ… **ë‹¨ì¼ ë°”ì´ë„ˆë¦¬ ë°°í¬**  

### Negative

âš ï¸ **ë†’ì€ ì´ˆê¸° ê°œë°œ ë¹„ìš©** (~4ì‹œê°„, 716ì¤„)  
âš ï¸ **ìƒˆë¡œìš´ ëª¨ë¸ ì¶”ê°€ ì‹œ ë ˆì´ì–´ ì¬êµ¬í˜„ í•„ìš”**  
âš ï¸ **PyTorch ìƒíƒœê³„ì™€ ë¶„ë¦¬**  
âš ï¸ **ìˆ˜ë™ ìµœì í™” í•„ìš”** (SIMD ë“±)  

### Neutral

ğŸ“ **ìœ ì§€ë³´ìˆ˜**: ì½”ë“œê°€ ì ê³  ì˜ì¡´ì„±ì´ ì—†ì–´ ì¥ê¸°ì ìœ¼ë¡œëŠ” ìœ ë¦¬  
ğŸ“ **í™•ì¥ì„±**: í•„ìš”í•œ ë ˆì´ì–´ë§Œ êµ¬í˜„í•˜ë©´ ë˜ë¯€ë¡œ ì„ íƒì   
ğŸ“ **ì„±ëŠ¥**: í˜„ì¬ë„ ì¶©ë¶„í•˜ì§€ë§Œ SIMD/ë©€í‹°ìŠ¤ë ˆë”©ìœ¼ë¡œ ë” ê°œì„  ê°€ëŠ¥  

## Follow-up Actions

1. âœ… ë©”ëª¨ë¦¬ í”„ë¡œíŒŒì¼ë§ ì™„ë£Œ
2. âœ… í•œêµ­ì–´ í’ˆì¢…ëª… í†µí•© ì™„ë£Œ
3. âœ… Git ë¬¸ì„œí™” ì§„í–‰ ì¤‘
4. ğŸ”² SIMD ìµœì í™” (ì„ íƒ ì‚¬í•­)
5. ğŸ”² ë²¤ì¹˜ë§ˆí¬ ìë™í™”
6. ğŸ”² Docker ì´ë¯¸ì§€ ìƒì„±

## References

- Project: `~/.openclaw/workspace/litecnn-pure-cpp/`
- Model: LiteCNNPro (600K params, 120 classes)
- Dataset: Stanford Dogs (120 breeds)
- Memory measurement: `ps -o rss` (RSS = Resident Set Size)

## Lessons Learned

1. **ì˜ì¡´ì„±ì´ ì ì„ìˆ˜ë¡ ë©”ëª¨ë¦¬ íš¨ìœ¨ì **: ëŸ°íƒ€ì„ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë©”ëª¨ë¦¬ì˜ ëŒ€ë¶€ë¶„ì„ ì°¨ì§€í•¨
2. **í—¤ë” ì˜¨ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ì¥ì **: ë°°í¬ ë‹¨ìˆœí™”, ìµœì í™” ê°€ëŠ¥ì„±
3. **ì¡°ê¸° ìµœì í™”ê°€ í•„ìš”í•  ë•Œ**: ë©”ëª¨ë¦¬ ì œì•½ì´ ëª…í™•í•œ ê²½ìš° ì²˜ìŒë¶€í„° Pure C++ ê³ ë ¤
4. **í•œêµ­ì–´ ì§€ì›ì€ ì‰½ë‹¤**: JSON ë§¤í•‘ë§Œìœ¼ë¡œ ì¶©ë¶„

---

**ê²°ë¡ **: Pure C++ êµ¬í˜„ì€ ì´ˆê¸° ë¹„ìš©ì´ ë†’ì§€ë§Œ, ë©”ëª¨ë¦¬ ì œì•½ì´ ì—„ê²©í•œ í™˜ê²½ì—ì„œëŠ” ìµœì„ ì˜ ì„ íƒì´ì—ˆìŠµë‹ˆë‹¤. ğŸ–¤
